<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The List Supper‚Ñ¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- META TAGS PARA CONTROL DE CACHE -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        /* ESTILOS PRINCIPALES (igual que antes) */
        :root {
            --color-pendiente: #8C8C8C;
            --color-chango: #48C4B2;
            --color-omitido: #F4A6A6;
            --color-oferta: #D4B662;
            --color-fondo: #1a202c;
            --color-texto: #e2e8f0;
            --color-borde: #4a5568;
            --color-surface: #2d3748;
            --color-grupo-header: #4a5568;
            --color-grupo-items: #2d3748;
            --color-item-fondo: rgba(255, 255, 255, 0.1);
            --sombra: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--color-fondo);
            color: var(--color-texto);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--color-surface);
            border-radius: 15px;
            box-shadow: var(--sombra);
        }
        
        h1 {
            color: #ffffff;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .title-tm {
            font-size: 0.8em;
            vertical-align: super;
            color: #48bb78;
        }
        
        .subtitle {
            color: #a0aec0;
            font-size: 1rem;
        }
        
        /* ... (todo el resto del CSS igual) ... */
        
        /* NUEVO: ESTILOS PARA DEBUG */
        .cache-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #48bb78;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 9998;
            opacity: 0.8;
        }
        
        .cache-warning {
            background: #e53e3e !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .cache-control-btn {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #2d3748;
            color: #a0aec0;
            border: 1px solid #4a5568;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 9997;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .cache-control-btn:hover {
            opacity: 1;
            background: #4a5568;
        }
    </style>
</head>
<body>
    <!-- BADGE DE VERSI√ìN -->
    <div class="cache-badge" id="versionBadge">v2025.2.0</div>
    
    <!-- BOT√ìN SECRETO DE CACHE -->
    <button class="cache-control-btn" id="cacheControlBtn" title="Control de Cache">
        ‚öôÔ∏è Cache
    </button>
    
    <!-- TRIGGER PANEL ADMIN (transparente) -->
    <button class="secret-trigger" id="secretTrigger" title="Panel Admin"></button>

    <div class="container">
        <header>
            <h1><i class="fas fa-shopping-cart"></i> The List Supper<span class="title-tm">‚Ñ¢</span></h1>
            <p class="subtitle">Organiza tu compra por zonas del supermercado</p>
            
            <div class="color-legend">
                <div class="legend-item"><div class="legend-color pendiente"></div><span>Pendiente</span></div>
                <div class="legend-item"><div class="legend-color chango"></div><span>En chango</span></div>
                <div class="legend-item"><div class="legend-color omitido"></div><span>Omitido</span></div>
                <div class="legend-item"><div class="legend-color oferta"></div><span>Oferta</span></div>
            </div>
        </header>

        <!-- PANEL DE ADMIN (OCULTO) -->
        <div class="admin-panel hidden" id="adminPanel">
            <h2 class="admin-title">üõ†Ô∏è PANEL DE CONTROL - THE LIST SUPPER‚Ñ¢</h2>
            
            <div class="admin-grid">
                <button class="admin-btn success" onclick="admin.agregarOfertas()">üéÅ Agregar Ofertas</button>
                <button class="admin-btn" onclick="admin.modoArcoiris()">üåà Modo Arco√≠ris</button>
                <button class="admin-btn warning" onclick="admin.duplicarItems()">üì¶ Duplicar Items</button>
                <button class="admin-btn" onclick="admin.exportarDatos()">üíæ Exportar Datos</button>
                <button class="admin-btn danger" onclick="admin.limpiarTodo()">üóëÔ∏è Limpiar Todo</button>
                <button class="admin-btn" onclick="admin.crearGruposEjemplo()">üè™ Grupos Ejemplo</button>
                <button class="admin-btn" onclick="admin.modoNormal()">‚¨õ Modo Normal</button>
                <button class="admin-btn voz" onclick="admin.togglePersonalizacion()">üé® Personalizar</button>
                
                <!-- NUEVO: BOTONES DE CONTROL DE CACHE -->
                <button class="admin-btn warning" onclick="cacheManager.forceUpdate()">üîÑ Forzar Update</button>
                <button class="admin-btn danger" onclick="cacheManager.nuclearOption()">üí£ Nuclear Cache</button>
                <button class="admin-btn" onclick="cacheManager.openClean()">üë§ Abrir Limpio</button>
            </div>

            <!-- PANEL DE DEBUG DE CACHE -->
            <div class="stats-panel">
                <h3>üìä DEBUG - ESTADO DEL CACHE</h3>
                <div id="cacheDebugInfo">
                    <div class="stat-item">
                        <span>Versi√≥n App:</span>
                        <strong id="debugVersion">...</strong>
                    </div>
                    <div class="stat-item">
                        <span>Versi√≥n SW:</span>
                        <strong id="debugSWVersion">...</strong>
                    </div>
                    <div class="stat-item">
                        <span>Service Workers:</span>
                        <strong id="debugSWCount">...</strong>
                    </div>
                    <div class="stat-item">
                        <span>Caches Activos:</span>
                        <strong id="debugCacheCount">...</strong>
                    </div>
                    <div class="stat-item">
                        <span>√öltima Actualizaci√≥n:</span>
                        <strong id="debugLastUpdate">...</strong>
                    </div>
                </div>
            </div>

            <!-- ... (resto del panel admin igual) ... -->
        </div>

        <!-- CONTROLES PRINCIPALES -->
        <div class="controls">
            <button class="add-group" id="addGroupBtn"><i class="fas fa-folder-plus"></i> Nuevo Grupo</button>
            <button class="add-item" id="addItemBtn"><i class="fas fa-plus"></i> Nuevo √çtem</button>
            <input type="text" id="newItemInput" placeholder="Escribe un nuevo √≠tem...">
        </div>

        <!-- CONTENEDOR DE GRUPOS -->
        <div class="groups-container" id="groupsContainer"></div>

        <!-- ESTAD√çSTICAS -->
        <div class="stats" id="stats"></div>
    </div>

    <!-- MODAL DE CONTROL DE CACHE (oculto) -->
    <div id="cacheModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center;">
        <div style="background: #2d3748; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h3 style="color: #48bb78; margin-bottom: 20px;">‚öôÔ∏è CONTROL DE CACHE</h3>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="cacheManager.softReset()" style="background: #4299e1;">üîÑ Reinicio Suave</button>
                <button onclick="cacheManager.hardReset()" style="background: #ed8936;">üóëÔ∏è Reinicio Fuerte</button>
                <button onclick="cacheManager.nuclearOption()" style="background: #e53e3e;">üí£ Opci√≥n Nuclear</button>
                <button onclick="cacheManager.openIncognito()" style="background: #9F7AEA;">üë§ Abrir Inc√≥gnito</button>
                <button onclick="cacheManager.closeModal()" style="background: #4a5568; margin-top: 20px;">‚úñÔ∏è Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CACHE MANAGER - SISTEMA DE CONTROL DE CACHE
        // =============================================
        const cacheManager = {
            APP_VERSION: '2025.2.0',
            
            init: function() {
                console.log(`üöÄ The List Supper‚Ñ¢ v${this.APP_VERSION} iniciando...`);
                
                // Verificar versi√≥n almacenada
                const storedVersion = localStorage.getItem('app_version');
                if (storedVersion && storedVersion !== this.APP_VERSION) {
                    console.log(`üîÑ Actualizaci√≥n detectada: ${storedVersion} ‚Üí ${this.APP_VERSION}`);
                    this.showUpdateNotification();
                }
                
                // Guardar versi√≥n actual
                localStorage.setItem('app_version', this.APP_VERSION);
                
                // Monitorear Service Worker
                this.monitorServiceWorker();
                
                // Actualizar badge
                document.getElementById('versionBadge').textContent = `v${this.APP_VERSION}`;
                
                // Event listeners
                document.getElementById('cacheControlBtn').addEventListener('click', () => this.openModal());
                
                // Check peri√≥dico de actualizaciones
                setInterval(() => this.checkForUpdates(), 30000); // Cada 30 segundos
            },
            
            monitorServiceWorker: function() {
                if ('serviceWorker' in navigator) {
                    // Registrar SW
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('‚úÖ Service Worker registrado:', registration.scope);
                            
                            // Escuchar actualizaciones
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                console.log('üîÑ Nuevo SW encontrado:', newWorker);
                                
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        this.showSWUpdateNotification();
                                    }
                                });
                            });
                            
                            // Forzar update check
                            registration.update();
                        })
                        .catch(error => {
                            console.error('‚ùå Error registrando SW:', error);
                            document.getElementById('versionBadge').classList.add('cache-warning');
                        });
                    
                    // Escuchar mensajes del SW
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data.type === 'SW_UPDATED') {
                            console.log(`üÜï SW actualizado a v${event.data.version}`);
                            this.showReloadNotification();
                        }
                    });
                }
            },
            
            checkForUpdates: function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.update();
                    });
                }
            },
            
            // ===== ACCIONES DE CACHE =====
            softReset: function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.update();
                        alert('üîÑ Actualizaci√≥n de SW forzada');
                    });
                }
            },
            
            hardReset: function() {
                if (confirm('¬øLimpiar cache del navegador?')) {
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                            alert(`üóëÔ∏è ${names.length} caches eliminados`);
                        });
                    }
                    setTimeout(() => location.reload(), 1000);
                }
            },
            
            nuclearOption: function() {
                if (confirm('üí£ ¬øOPCI√ìN NUCLEAR?\n\nEsto eliminar√°:\n‚Ä¢ Service Workers\n‚Ä¢ Caches del navegador\n‚Ä¢ localStorage\n\n¬øContinuar?')) {
                    // 1. Desregistrar SW
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            registrations.forEach(reg => reg.unregister());
                        });
                    }
                    
                    // 2. Eliminar caches
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    
                    // 3. Limpiar localStorage (excepto datos de la app)
                    const keepKeys = ['superListGroups', 'theListSupperColors'];
                    const allKeys = Object.keys(localStorage);
                    allKeys.forEach(key => {
                        if (!keepKeys.includes(key)) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // 4. Recargar sin cache
                    setTimeout(() => {
                        window.location.href = window.location.origin + '?_nuke=' + Date.now();
                    }, 500);
                }
            },
            
            forceUpdate: function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        if (registration.waiting) {
                            registration.waiting.postMessage('skipWaiting');
                            alert('üîÑ Saltando a nueva versi√≥n...');
                            setTimeout(() => location.reload(), 500);
                        } else {
                            registration.update();
                            alert('üîç Buscando actualizaciones...');
                        }
                    });
                }
            },
            
            openClean: function() {
                const url = window.location.href;
                window.open(url, '_blank');
                alert('üë§ Abriendo en nueva pesta√±a (sin cache)');
            },
            
            openIncognito: function() {
                const url = window.location.href;
                // Intenta abrir en inc√≥gnito (no siempre funciona por pol√≠ticas)
                window.open(url, '_blank');
                alert('üåê Abriendo en nueva ventana. Para inc√≥gnito manual: Ctrl+Shift+N');
            },
            
            // ===== UI HELPERS =====
            showUpdateNotification: function() {
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #48bb78; color: white; padding: 15px; border-radius: 8px; z-index: 10002; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                        <strong>üîÑ Nueva versi√≥n disponible!</strong>
                        <p style="margin: 5px 0; font-size: 0.9rem;">Recarga para actualizar</p>
                        <button onclick="location.reload()" style="background: white; color: #48bb78; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px;">
                            Actualizar Ahora
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 10000);
            },
            
            showSWUpdateNotification: function() {
                if (confirm('üÜï Hay una actualizaci√≥n disponible. ¬øRecargar ahora?')) {
                    location.reload();
                }
            },
            
            showReloadNotification: function() {
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="position: fixed; bottom: 20px; right: 20px; background: #4299e1; color: white; padding: 15px; border-radius: 8px; z-index: 10002; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                        <strong>‚úÖ Aplicaci√≥n actualizada</strong>
                        <p style="margin: 5px 0; font-size: 0.9rem;">Recarga para usar la nueva versi√≥n</p>
                        <button onclick="location.reload()" style="background: white; color: #4299e1; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px;">
                            Recargar
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 15000);
            },
            
            openModal: function() {
                document.getElementById('cacheModal').classList.remove('hidden');
            },
            
            closeModal: function() {
                document.getElementById('cacheModal').classList.add('hidden');
            },
            
            updateDebugInfo: function() {
                if (!document.getElementById('adminPanel').classList.contains('hidden')) {
                    document.getElementById('debugVersion').textContent = this.APP_VERSION;
                    
                    // Info SW
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(regs => {
                            document.getElementById('debugSWCount').textContent = regs.length;
                        });
                    }
                    
                    // Info Cache
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            document.getElementById('debugCacheCount').textContent = names.length;
                        });
                    }
                    
                    document.getElementById('debugLastUpdate').textContent = new Date().toLocaleTimeString();
                }
            }
        };

        // =============================================
        // ADMIN CONTROLLER (igual que antes, simplificado)
        // =============================================
        const admin = {
            togglePanel: function() {
                const panel = document.getElementById('adminPanel');
                panel.classList.toggle('hidden');
                if(!panel.classList.contains('hidden')) {
                    admin.actualizarEstadisticas();
                    admin.cargarColoresGuardados();
                    cacheManager.updateDebugInfo();
                    setInterval(cacheManager.updateDebugInfo, 2000);
                }
            },
            
            // ... (todas las otras funciones de admin IGUALES que antes) ...
            // [Mantener todas las funciones existentes: agregarOfertas, modoArcoiris, etc.]
        };

        // =============================================
        // APP PRINCIPAL (igual que antes)
        // =============================================
        let groups = JSON.parse(localStorage.getItem('superListGroups')) || [
            {
                id: 1,
                name: "PANADER√çA",
                collapsed: false,
                items: [
                    { id: 101, name: "Pan", color: "pendiente" },
                    { id: 102, name: "Facturas", color: "pendiente" }
                ]
            },
            {
                id: 2,
                name: "L√ÅCTEOS Y HELADERA",
                collapsed: false,
                items: [
                    { id: 201, name: "Leche", color: "pendiente" },
                    { id: 202, name: "Queso", color: "pendiente" },
                    { id: 203, name: "Yogur", color: "pendiente" }
                ]
            },
            {
                id: 3,
                name: "LIMPIEZA",
                collapsed: false,
                items: [
                    { id: 301, name: "Lavandina", color: "pendiente" },
                    { id: 302, name: "Detergente", color: "pendiente" }
                ]
            }
        ];

        let nextGroupId = 4;
        let nextItemId = 303;
        let draggedItem = null;

        // INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Iniciar cache manager PRIMERO
            cacheManager.init();
            
            // 2. Iniciar app
            renderGroups();
            updateStats();
            admin.cargarColoresGuardados();
            
            // 3. Event listeners
            document.getElementById('addGroupBtn').addEventListener('click', addNewGroup);
            document.getElementById('addItemBtn').addEventListener('click', addNewItem);
            document.getElementById('newItemInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNewItem();
            });

            // Panel admin secreto
            document.getElementById('secretTrigger').addEventListener('click', () => admin.togglePanel());
            document.addEventListener('keydown', function(e) {
                if(e.ctrlKey && e.shiftKey && e.key === 'A') {
                    e.preventDefault();
                    admin.togglePanel();
                }
            });

            console.log('‚úÖ The List Supper‚Ñ¢ completamente cargado');
        });

        // ... (resto de funciones de la app IGUALES: renderGroups, addNewGroup, etc.) ...
        // [Mantener todas las funciones existentes de la aplicaci√≥n]

        // Funciones de la app (se mantienen iguales)
        function renderGroups() { /* ... */ }
        function addNewGroup() { /* ... */ }
        function addNewItem() { /* ... */ }
        function toggleGroupCollapse(groupId) { /* ... */ }
        function deleteGroup(groupId) { /* ... */ }
        function changeItemColor(itemId) { /* ... */ }
        function deleteItem(groupId, itemId) { /* ... */ }
        function moveItemToGroup(sourceGroupId, itemId, targetGroupId) { /* ... */ }
        function updateStats() { /* ... */ }
        function saveToLocalStorage() { /* ... */ }
    </script>
</body>
</html>